name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc-12, clang-15]
        
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build cmake
        if [[ "${{ matrix.compiler }}" == "gcc-12" ]]; then
          sudo apt-get install -y g++-12
          echo "CC=gcc-12" >> $GITHUB_ENV
          echo "CXX=g++-12" >> $GITHUB_ENV
        else
          sudo apt-get install -y clang-15
          echo "CC=clang-15" >> $GITHUB_ENV
          echo "CXX=clang++-15" >> $GITHUB_ENV
        fi
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: Download ONNX Models
      run: python scripts/download_models.py --all
      continue-on-error: true
      
    - name: Configure CMake
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_C_COMPILER=${CC} \
          -DCMAKE_CXX_COMPILER=${CXX} \
          -DVDB_BUILD_TESTS=ON \
          -DVDB_BUILD_PYTHON=ON
          
    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }}
      
    - name: Run C++ Tests
      working-directory: build
      run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure --verbose
      
    - name: Run Python Tests
      run: pytest tests/ -v --tb=short
      continue-on-error: true

  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        
    - name: Install Ninja
      run: choco install ninja -y
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: Download ONNX Models
      run: python scripts/download_models.py --all
      continue-on-error: true
      
    - name: Configure CMake
      run: |
        cmake -B build -G Ninja `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
          -DVDB_BUILD_TESTS=ON `
          -DVDB_BUILD_PYTHON=ON
          
    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }}
      
    - name: Run C++ Tests
      working-directory: build
      run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure --verbose
      
    - name: Run Python Tests
      run: pytest tests/ -v --tb=short
      continue-on-error: true

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Install Dependencies
      run: brew install cmake ninja
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: Download ONNX Models
      run: python scripts/download_models.py --all
      continue-on-error: true
      
    - name: Configure CMake
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DVDB_BUILD_TESTS=ON \
          -DVDB_BUILD_PYTHON=ON
          
    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }}
      
    - name: Run C++ Tests
      working-directory: build
      run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure --verbose
      
    - name: Run Python Tests
      run: pytest tests/ -v --tb=short
      continue-on-error: true

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install Linters
      run: |
        pip install ruff mypy pytest
        sudo apt-get install -y clang-format-15
        
    - name: Run Ruff (Python)
      run: ruff check scripts/ bindings/python/
      continue-on-error: true
      
    - name: Check C++ Formatting
      run: |
        find src include -name '*.cpp' -o -name '*.hpp' | \
          xargs clang-format-15 --dry-run --Werror
      continue-on-error: true
    
    - name: Run Documentation Tests
      run: |
        python tests/test_documentation.py
        pytest tests/test_documentation.py -v

  coverage:
    runs-on: ubuntu-latest
    needs: build-linux
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build cmake g++-12 lcov
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
        
    - name: Configure CMake with Coverage
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=gcc-12 \
          -DCMAKE_CXX_COMPILER=g++-12 \
          -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
          -DVDB_BUILD_TESTS=ON
          
    - name: Build
      run: cmake --build build
      
    - name: Run Tests
      working-directory: build
      run: ctest --output-on-failure
      
    - name: Generate Coverage Report
      run: |
        lcov --capture --directory build --output-file coverage.info
        lcov --remove coverage.info '/usr/*' '*/tests/*' --output-file coverage.info
        lcov --list coverage.info
        
    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: coverage.info
        fail_ci_if_error: false
