name: CI

on:
  push:
    branches: [main, develop, 'copilot/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  CACHE_VERSION: v1

jobs:
  # Quick checks that run first
  lint-and-format:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        
    - name: Install Linters
      run: |
        pip install ruff mypy black isort
        sudo apt-get update && sudo apt-get install -y clang-format-18
        
    - name: Run Ruff (Python Linting)
      run: ruff check scripts/ bindings/python/ --fix
      continue-on-error: true
      
    - name: Run Black (Python Formatting)
      run: black --check scripts/ bindings/python/
      continue-on-error: true
      
    - name: Check C++ Formatting
      run: |
        find src include -name '*.cpp' -o -name '*.hpp' | \
          xargs clang-format-18 --dry-run --Werror
      continue-on-error: true
      
    - name: Run MyPy (Type Checking)
      run: mypy scripts/ bindings/python/ --ignore-missing-imports
      continue-on-error: true

  # Build and test matrix
  # NOTE: This project requires C++23 std::expected which needs:
  #   - GCC 13+ (GCC 12 has incomplete std::expected)
  #   - Clang 16+ (Clang 15 doesn't have std::expected)
  #   - MSVC 19.33+ (VS 2022 17.3+)
  build-test:
    name: Build & Test (${{ matrix.os }}, ${{ matrix.compiler || 'default' }})
    needs: lint-and-format
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, windows-latest, macos-14]
        include:
          - os: ubuntu-24.04
            compiler: gcc-14
            cache-key: linux-gcc14
          - os: ubuntu-24.04
            compiler: clang-18
            cache-key: linux-clang18
          - os: windows-latest
            cache-key: windows-msvc
          - os: macos-14
            cache-key: macos-clang
        
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1
        
    # Cache dependencies
    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: |
          build
          ~/.cache/pip
          ~/Library/Caches/pip
          ~\AppData\Local\pip\Cache
        key: ${{ matrix.cache-key }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/CMakeLists.txt', 'requirements.txt') }}
        restore-keys: |
          ${{ matrix.cache-key }}-${{ env.CACHE_VERSION }}-
        
    # Linux setup
    - name: Install Dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build cmake libcurl4-openssl-dev libsqlite3-dev
        if [[ "${{ matrix.compiler }}" == "gcc-14" ]]; then
          sudo apt-get install -y g++-14
          echo "CC=gcc-14" >> $GITHUB_ENV
          echo "CXX=g++-14" >> $GITHUB_ENV
        elif [[ "${{ matrix.compiler }}" == "clang-18" ]]; then
          # Install clang-18 with libc++ for full C++23 support (std::expected)
          sudo apt-get install -y clang-18 libc++-18-dev libc++abi-18-dev
          echo "CC=clang-18" >> $GITHUB_ENV
          echo "CXX=clang++-18" >> $GITHUB_ENV
          # Use libc++ instead of libstdc++ for full C++23 std::expected support
          echo "CXXFLAGS=-stdlib=libc++" >> $GITHUB_ENV
          echo "LDFLAGS=-stdlib=libc++ -lc++abi" >> $GITHUB_ENV
        fi
        
    # Windows setup
    - name: Setup MSVC (Windows)
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        
    - name: Install Dependencies (Windows)
      if: runner.os == 'Windows'
      run: choco install ninja cmake -y
      
    # macOS setup
    - name: Install Dependencies (macOS)
      if: runner.os == 'macOS'
      run: brew install cmake ninja
      
    # Python setup (all platforms)
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        
    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt || echo "No requirements.txt"
        pip install pytest pytest-xdist || true
        
    # Configure and build
    - name: Configure CMake
      run: |
        # Disable llama.cpp on Windows due to OpenMP/ggml linking issues in CI
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          LLAMA_OPT="-DVDB_USE_LLAMA_CPP=OFF"
        else
          LLAMA_OPT="-DVDB_USE_LLAMA_CPP=ON"
        fi
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DVDB_BUILD_TESTS=ON \
          -DVDB_BUILD_PYTHON=OFF \
          -DVDB_USE_ONNX_RUNTIME=OFF \
          $LLAMA_OPT
      shell: bash
          
    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel
      
    # Run tests
    - name: Run C++ Tests
      working-directory: build
      run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure --parallel 2
      timeout-minutes: 15
      
    - name: Upload test results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.compiler || 'default' }}
        path: build/Testing/Temporary/
        retention-days: 3

  # Documentation validation
  docs-validation:
    name: Documentation Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Validate Markdown
      run: |
        pip install markdown-link-check || true
        find docs -name '*.md' -exec echo "Checking {}" \;
        
    - name: Check for broken links
      run: |
        find docs -name '*.md' | while read file; do
          echo "Validating $file"
          grep -oP '\[.*?\]\(\K[^)]+' "$file" | while read link; do
            if [[ "$link" =~ ^http ]]; then
              echo "External link: $link"
            elif [[ -f "docs/$link" ]] || [[ -f "$link" ]]; then
              echo "✓ Valid: $link"
            else
              echo "⚠ Broken: $link in $file"
            fi
          done
        done
      continue-on-error: true

  # Security scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      security-events: write
      contents: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true
      
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
      if: always()

  # Success check
  ci-success:
    name: CI Success
    needs: [lint-and-format, build-test, docs-validation, security-scan]
    runs-on: ubuntu-latest
    if: always()
    permissions: {}
    
    steps:
    - name: Check CI status
      run: |
        if [[ "${{ needs.lint-and-format.result }}" != "success" ]] || \
           [[ "${{ needs.build-test.result }}" != "success" ]]; then
          echo "CI failed"
          exit 1
        fi
        echo "CI passed successfully!"
